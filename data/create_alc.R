# Rita Beigaite 11.11.2020 - RStudio exercise #3 for the IODS course
# Data source: UCI Machine Learning Repository (http://archive.ics.uci.edu/ml/dataset)
# Metadata available at: https://archive.ics.uci.edu/ml/datasets/Student+Performance

source <- "http://archive.ics.uci.edu/ml/machine-learning-databases/00320/student.zip"
dest <- "~/IODS-project/data/student.zip"

# Loading data from the web and unziping it
download.file(source,dest)
unzip(dest,exdir="~/IODS-project/data/student")


# Reading the datasets into memory
por <- read.table("data/student/student-por.csv", sep = ";", header=TRUE)
math <- read.table("data/student/student-mat.csv", sep = ";", header=TRUE)

# Exploring the structure and dimensions for both files

str(por)
#'data.frame':	649 obs. of  33 variables:
#  $ school    : chr  "GP" "GP" "GP" "GP" ...
#$ sex       : chr  "F" "F" "F" "F" ...
#$ age       : int  18 17 15 15 16 16 16 17 15 15 ...
#$ address   : chr  "U" "U" "U" "U" ...
#$ famsize   : chr  "GT3" "GT3" "LE3" "GT3" ...
#$ Pstatus   : chr  "A" "T" "T" "T" ...
#$ Medu      : int  4 1 1 4 3 4 2 4 3 3 ...
#$ Fedu      : int  4 1 1 2 3 3 2 4 2 4 ...
#$ Mjob      : chr  "at_home" "at_home" "at_home" "health" ...
#$ Fjob      : chr  "teacher" "other" "other" "services" ...
#$ reason    : chr  "course" "course" "other" "home" ...
#$ guardian  : chr  "mother" "father" "mother" "mother" ...
#$ traveltime: int  2 1 1 1 1 1 1 2 1 1 ...
#$ studytime : int  2 2 2 3 2 2 2 2 2 2 ...
#$ failures  : int  0 0 0 0 0 0 0 0 0 0 ...
#$ schoolsup : chr  "yes" "no" "yes" "no" ...
#$ famsup    : chr  "no" "yes" "no" "yes" ...
#$ paid      : chr  "no" "no" "no" "no" ...
#$ activities: chr  "no" "no" "no" "yes" ...
#$ nursery   : chr  "yes" "no" "yes" "yes" ...
#$ higher    : chr  "yes" "yes" "yes" "yes" ...
#$ internet  : chr  "no" "yes" "yes" "yes" ...
#$ romantic  : chr  "no" "no" "no" "yes" ...
#$ famrel    : int  4 5 4 3 4 5 4 4 4 5 ...
#$ freetime  : int  3 3 3 2 3 4 4 1 2 5 ...
#$ goout     : int  4 3 2 2 2 2 4 4 2 1 ...
#$ Dalc      : int  1 1 2 1 1 1 1 1 1 1 ...
#$ Walc      : int  1 1 3 1 2 2 1 1 1 1 ...
#$ health    : int  3 3 3 5 5 5 3 1 1 5 ...
#$ absences  : int  4 2 6 0 0 6 0 2 0 0 ...
#$ G1        : int  0 9 12 14 11 12 13 10 15 12 ...
#$ G2        : int  11 11 13 14 13 12 12 13 16 12 ...
#$ G3        : int  11 11 12 14 13 13 13 13 17 13 ...

dim(por)
#[1] 649  33


str(math)
#'data.frame':	395 obs. of  33 variables:
# $ school    : chr  "GP" "GP" "GP" "GP" ...
#$ sex       : chr  "F" "F" "F" "F" ...
#$ age       : int  18 17 15 15 16 16 16 17 15 15 ...
#$ address   : chr  "U" "U" "U" "U" ...
#$ famsize   : chr  "GT3" "GT3" "LE3" "GT3" ...
#$ Pstatus   : chr  "A" "T" "T" "T" ...
#$ Medu      : int  4 1 1 4 3 4 2 4 3 3 ...
#$ Fedu      : int  4 1 1 2 3 3 2 4 2 4 ...
#$ Mjob      : chr  "at_home" "at_home" "at_home" "health" ...
#$ Fjob      : chr  "teacher" "other" "other" "services" ...
#$ reason    : chr  "course" "course" "other" "home" ...
#$ guardian  : chr  "mother" "father" "mother" "mother" ...
#$ traveltime: int  2 1 1 1 1 1 1 2 1 1 ...
#$ studytime : int  2 2 2 3 2 2 2 2 2 2 ...
#$ failures  : int  0 0 3 0 0 0 0 0 0 0 ...
#$ schoolsup : chr  "yes" "no" "yes" "no" ...
#$ famsup    : chr  "no" "yes" "no" "yes" ...
#$ paid      : chr  "no" "no" "yes" "yes" ...
#$ activities: chr  "no" "no" "no" "yes" ...
#$ nursery   : chr  "yes" "no" "yes" "yes" ...
#$ higher    : chr  "yes" "yes" "yes" "yes" ...
#$ internet  : chr  "no" "yes" "yes" "yes" ...
#$ romantic  : chr  "no" "no" "no" "yes" ...
#$ famrel    : int  4 5 4 3 4 5 4 4 4 5 ...
#$ freetime  : int  3 3 3 2 3 4 4 1 2 5 ...
#$ goout     : int  4 3 2 2 2 2 4 4 2 1 ...
#$ Dalc      : int  1 1 2 1 1 1 1 1 1 1 ...
#$ Walc      : int  1 1 3 1 2 2 1 1 1 1 ...
#$ health    : int  3 3 3 5 5 5 3 1 1 5 ...
#$ absences  : int  6 4 10 2 4 10 0 6 0 0 ...
#$ G1        : int  5 5 7 15 6 15 12 6 16 14 ...
#$ G2        : int  6 5 8 14 10 15 12 5 18 15 ...
#$ G3        : int  6 6 10 15 10 15 11 6 19 15 ...


dim(math)
#[1] 395  33



########################################################
#-------------------------------------------------------
# For joining data sets to one dataset and taking the average of the answers 
# related to weekday and weekend alcohol consumption, will be using 
# Reijo Sund's code which can be found in:
# https://github.com/rsund/IODS-project/blob/master/data/create_alc.R
#-------------------------------------------------------
########################################################

# Defining own id for both datasets
library(dplyr)
por_id <- por %>% mutate(id=1000+row_number()) 
math_id <- math %>% mutate(id=2000+row_number())

# Which columns vary in datasets
free_cols <- c("id","failures","paid","absences","G1","G2","G3")

# The rest of the columns are common identifiers used for joining the datasets
join_cols <- setdiff(colnames(por_id),free_cols)


pormath_free <- por_id %>% bind_rows(math_id) %>% select(one_of(free_cols))

# Combining datasets to one long data
pormath <- por_id %>% 
  bind_rows(math_id) %>%
  # Aggregating data   
  group_by(.dots=join_cols) %>%  
  # Calculating required variables from two obs  
  summarise(                                                           
    n=n(),
    id.p=min(id),
    id.m=max(id),
    failures=round(mean(failures)),     #  Rounded mean for numerical
    paid=first(paid),                   #    and first for chars
    absences=round(mean(absences)),
    G1=round(mean(G1)),
    G2=round(mean(G2)),
    G3=round(mean(G3))    
  ) %>%
  # Remove lines that do not have exactly one obs from both datasets
  #   There must be exactly 2 observations found in order to joining be succesful
  #   In addition, 2 obs to be joined must be 1 from por and 1 from math
  #     (id:s differ more than max within one dataset (649 here))
  filter(n==2, id.m-id.p>650) %>%  
  # Join original free fields, because rounded means or first values may not be relevant
  inner_join(pormath_free,by=c("id.p"="id"),suffix=c("",".p")) %>%
  inner_join(pormath_free,by=c("id.m"="id"),suffix=c("",".m")) %>%
  # Calculate other required variables  
  ungroup %>% mutate(
    alc_use = (Dalc + Walc) / 2,
    high_use = alc_use > 2,
    cid=3000+row_number()
  )

##################################################################
##################################################################

#Cheking sturcture and dimentions of pormath data frame
str(pormath)
dim(pormath)
#[1] 370  51


# Creating a new data frame with only the joined columns
alc <- select(pormath, one_of(join_cols))


# Columns that were not used for joining the data
notjoined_columns <- colnames(math)[!colnames(math) %in% join_cols]

# Adding derived alc_use and high_use variables to the list of not joined columns
notjoined_columns <- c(notjoined_columns, 'alc_use', 'high_use')

# For every column name not used for joining...
for(column_name in notjoined_columns) {
  # Selecting two columns from 'pormath' with the same original name
  two_columns <- select(pormath, starts_with(column_name))
  # Selecting the first column vector of those two columns
  first_column <- select(two_columns, 1)[[1]]
  
  # If that first column  vector is numeric...
  if(is.numeric(first_column)) {
    # Taking a rounded average of each row of the two columns and
    # adding the resulting vector to the alc data frame
    alc[column_name] <- round(rowMeans(two_columns))
  } else { # else if it's not numeric...
    # Adding the first column vector to the alc data frame
    alc[column_name] <- first_column
  }
}

# Glimpse at the new combined data
glimpse(alc)

dim(alc)
#[1] 370  35

# Saving created data to folder 'data' as a .csv file
write.csv(alc,file="data/alc.csv", row.names = F)
test <- read.csv('data/alc.csv')
head(test)
dim(test)

